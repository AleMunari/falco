<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MyEYES">
<meta name="theme-color" content="#000000">
<title>MyEYES</title>

<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%23000000'/%3E%3Ctext x='90' y='118' font-size='52' text-anchor='middle' font-family='Georgia,serif' fill='%23FFE600' font-weight='bold'%3EMyEYES%3C/text%3E%3C/svg%3E">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">

<style>
:root {
  --bg:      #000000;
  --surface: #111111;
  --card:    #1a1a1a;
  --border:  #444444;
  --yellow:  #FFE000;
  --green:   #00C94A;
  --blue:    #00AAFF;
  --red:     #FF1A1A;
  --purple:  #AA00FF;
  --text:    #ffffff;
  --muted:   #aaaaaa;
  --r:       22px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  height: 100%; width: 100%;
  background: var(--bg);
  font-family: 'Nunito', sans-serif;
  color: var(--text);
  overflow: hidden;
}

#app {
  display: none;
  position: fixed; inset: 0;
  flex-direction: column;
  background: var(--bg);
}

/* STATUS */
#status-bar {
  padding: 8px 20px;
  padding-top: max(8px, env(safe-area-inset-top));
  background: var(--card);
  font-size: 1rem; font-weight: 700; color: var(--muted);
  min-height: 38px; display: flex; align-items: center; gap: 8px;
  flex-shrink: 0; border-bottom: 2px solid var(--border);
}
#status-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--muted); flex-shrink: 0; transition: background .3s;
}
#status-dot.active    { background: var(--green); animation: pulse 1.5s infinite; }
#status-dot.listening { background: var(--red);   animation: pulse .5s infinite; }
#status-dot.error     { background: #ff4444; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.2} }
#status-text { flex: 1; }

/* SCROLL AREA — tutto in una pagina senza scroll se possibile */
.scroll-area {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  padding: 10px 12px;
  display: flex; flex-direction: column; gap: 10px;
  -webkit-overflow-scrolling: touch;
}

/* PREVIEW */
#preview-wrap {
  display: none; width: 100%; border-radius: var(--r);
  overflow: hidden; position: relative;
  border: 2px solid var(--yellow); max-height: 160px;
}
#preview-img { width: 100%; object-fit: cover; max-height: 160px; display: block; }
.preview-close {
  position: absolute; top: 8px; right: 8px;
  width: 34px; height: 34px;
  background: rgba(0,0,0,.75); border: none; border-radius: 50%;
  color: white; font-size: 1.1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Nunito', sans-serif; font-weight: 900;
}

/* GRIGLIA 2 colonne */
.row-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

/* BOTTONI GENERICI */
.btn {
  width: 100%; padding: 0;
  border: none; border-radius: var(--r);
  cursor: pointer;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: transform .12s, filter .12s;
  font-family: 'Nunito', sans-serif;
  position: relative; overflow: hidden;
}
.btn:active { transform: scale(.95); filter: brightness(.85); }

.btn-label {
  font-size: 2rem; font-weight: 900;
  letter-spacing: 1px; line-height: 1;
  color: #fff;
}
.btn-sub {
  font-size: 0.9rem; font-weight: 700;
  color: rgba(255,255,255,.75); margin-top: 4px;
}

/* RIGA 1: FOTO + CHIEDI — stessa riga */
#btn-camera {
  background: linear-gradient(160deg, #FFF500 0%, #FFB800 100%);
  box-shadow: 0 8px 36px rgba(255,220,0,.8);
  padding: 30px 10px;
}
#btn-camera .btn-label { color: #000000; font-size: 2.4rem; letter-spacing: 2px; }
#btn-camera .btn-sub   { color: rgba(0,0,0,.65); }

/* CHIEDI toggle */
#btn-play {
  background: linear-gradient(135deg, #00E5FF 0%, #0077FF 100%);
  box-shadow: 0 6px 28px rgba(0,200,255,.7);
  padding: 30px 10px;
}
#btn-play.recording {
  background: linear-gradient(135deg, #FF2222 0%, #CC0000 100%);
  box-shadow: 0 6px 28px rgba(255,30,30,.7);
}

/* RIGA 2: GALLERIA + DESCRIVI */
#btn-gallery {
  background: linear-gradient(135deg, #FF7A00 0%, #B34400 100%);
  box-shadow: 0 6px 28px rgba(255,100,0,.7);
  padding: 26px 10px;
}
#btn-describe {
  background: linear-gradient(135deg, #00FF66 0%, #00AA44 100%);
  box-shadow: 0 6px 28px rgba(0,255,90,.6);
  padding: 26px 10px;
}
#btn-describe .btn-label { color: #000; }
#btn-describe .btn-sub   { color: rgba(0,0,0,.65); }

/* RIGA 3: BUS + ESCI */
#btn-bus {
  background: linear-gradient(135deg, #CC00FF 0%, #7700BB 100%);
  box-shadow: 0 6px 28px rgba(180,0,255,.7);
  padding: 26px 10px;
}
/* ESCI: bianco su rosso */
#btn-exit {
  background: linear-gradient(135deg, #FF3333 0%, #CC0000 100%);
  box-shadow: 0 6px 28px rgba(255,30,30,.5);
  padding: 26px 10px;
}
#btn-exit .btn-label { color: #ffffff; }
#btn-exit .btn-sub   { color: rgba(255,255,255,.75); }

/* Onda animata dentro CHIEDI */
.wave-bar {
  display: none; align-items: center; justify-content: center; gap: 4px;
  height: 22px; margin-top: 5px;
}
.wave-bar.show { display: flex; }
.wave-bar span {
  width: 4px; background: white; border-radius: 3px;
  animation: wave .7s ease-in-out infinite;
}
.wave-bar span:nth-child(1){height:6px;animation-delay:0s}
.wave-bar span:nth-child(2){height:16px;animation-delay:.1s}
.wave-bar span:nth-child(3){height:22px;animation-delay:.2s}
.wave-bar span:nth-child(4){height:12px;animation-delay:.3s}
.wave-bar span:nth-child(5){height:18px;animation-delay:.15s}
.wave-bar span:nth-child(6){height:9px;animation-delay:.25s}
.wave-bar span:nth-child(7){height:16px;animation-delay:.05s}
@keyframes wave { 0%,100%{transform:scaleY(1)} 50%{transform:scaleY(.25)} }

/* Trascrizione */
#voice-transcript {
  text-align: center; font-size: 0.9rem; font-weight: 700;
  color: var(--muted); line-height: 1.4;
  padding: 0 4px; min-height: 20px;
}

/* ══ GTT PANEL ══ */
#gtt-panel {
  display: none;
  background: var(--card); border: 2px solid var(--border);
  border-radius: var(--r); padding: 14px 12px;
  flex-direction: column; gap: 10px;
}
#gtt-panel.open { display: flex; }
.gtt-title {
  font-size: 1.1rem; font-weight: 900; color: var(--yellow);
  text-align: center; letter-spacing: 1px;
}
#gtt-coords {
  font-size: 0.85rem; font-weight: 700; color: var(--muted);
  text-align: center; line-height: 1.4;
}
/* Tasto Rileva posizione — NERO su BIANCO */
#btn-gtt-location {
  width: 100%; padding: 20px;
  background: #FFFFFF;
  box-shadow: 0 4px 18px rgba(255,255,255,.35);
  border: none; border-radius: 16px;
  font-family: 'Nunito', sans-serif; font-size: 1.4rem; font-weight: 900;
  color: #000000; cursor: pointer; text-align: center;
  transition: filter .12s, transform .12s;
}
#btn-gtt-location:active { filter: brightness(.85); transform: scale(.97); }

/* CHIEDI GTT toggle — azzurro/rosso come il principale */
#btn-gtt-mic {
  width: 100%; padding: 24px 10px;
  background: linear-gradient(135deg, #00E5FF 0%, #0077FF 100%);
  box-shadow: 0 6px 28px rgba(0,200,255,.7);
  border: none; border-radius: var(--r);
  font-family: 'Nunito', sans-serif; font-size: 2rem; font-weight: 900;
  color: #fff; cursor: pointer; text-align: center;
  transition: background .2s, box-shadow .2s, transform .12s;
  letter-spacing: 2px;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
}
#btn-gtt-mic:active { transform: scale(.96); filter: brightness(.85); }
#btn-gtt-mic.recording {
  background: linear-gradient(135deg, #FF2222 0%, #CC0000 100%);
  box-shadow: 0 6px 28px rgba(255,30,30,.7);
}
#gtt-mic-sub { font-size: 0.9rem; font-weight: 700; color: rgba(255,255,255,.8); }
/* onda dentro CHIEDI GTT */
#gtt-wave-bar {
  display: none; align-items: center; justify-content: center; gap: 4px; height: 20px;
}
#gtt-wave-bar.show { display: flex; }
#gtt-wave-bar span {
  width: 4px; background: white; border-radius: 3px;
  animation: wave .7s ease-in-out infinite;
}
#gtt-wave-bar span:nth-child(1){height:5px;animation-delay:0s}
#gtt-wave-bar span:nth-child(2){height:14px;animation-delay:.1s}
#gtt-wave-bar span:nth-child(3){height:20px;animation-delay:.2s}
#gtt-wave-bar span:nth-child(4){height:10px;animation-delay:.3s}
#gtt-wave-bar span:nth-child(5){height:16px;animation-delay:.15s}

/* SETTINGS */
#settings-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.8); align-items: flex-end;
}
#settings-overlay.open { display: flex; }
.settings-sheet {
  width: 100%; background: var(--card);
  border-radius: 24px 24px 0 0;
  padding: 22px 22px max(22px, env(safe-area-inset-bottom));
  display: flex; flex-direction: column; gap: 14px;
}
.s-handle { width: 44px; height: 5px; background: var(--border); border-radius: 3px; margin: 0 auto 4px; }
.s-title { font-size: 1.2rem; font-weight: 900; color: var(--yellow); }
.s-row { display: flex; gap: 10px; }
.s-input {
  flex: 1; padding: 14px 16px;
  background: var(--bg); border: 2px solid var(--border);
  border-radius: 14px; color: var(--text);
  font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700;
  outline: none;
}
.s-save {
  padding: 14px 18px; background: var(--yellow); color: #000;
  border: none; border-radius: 14px;
  font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 1rem;
  cursor: pointer;
}
.s-close {
  padding: 14px; background: var(--border); border: none;
  border-radius: 14px; color: var(--muted);
  font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700;
  cursor: pointer; text-align: center;
}
.s-info { font-size: 0.85rem; font-weight: 700; color: var(--muted); line-height: 1.5; }
.s-info a { color: var(--yellow); }

/* Bottone impostazioni piccolo in basso a destra */
#settings-fab {
  position: fixed; bottom: max(18px, env(safe-area-inset-bottom)); right: 16px;
  width: 42px; height: 42px;
  background: var(--yellow);
  border: none; border-radius: 12px;
  color: #000; font-size: 1.2rem;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 200;
  box-shadow: 0 4px 16px rgba(255,220,0,.6);
}

.bottom-spacer { height: max(60px, calc(env(safe-area-inset-bottom) + 60px)); flex-shrink: 0; }
</style>
</head>
<body>

<div id="app">
  <!-- STATUS (rimane, serve per accessibilità) -->
  <div id="status-bar">
    <div id="status-dot"></div>
    <div id="status-text">Pronto.</div>
  </div>

  <div class="scroll-area">

    <!-- PREVIEW immagine -->
    <div id="preview-wrap">
      <img id="preview-img" src="" alt="Immagine caricata">
      <button class="preview-close" onclick="clearImage()">X</button>
    </div>

    <!-- RIGA 1: FOTO + CHIEDI -->
    <div class="row-2">
      <button class="btn" id="btn-camera" onclick="openCamera()">
        <span class="btn-label">FOTO</span>
        <span class="btn-sub">Fotocamera</span>
      </button>
      <button class="btn" id="btn-play" onclick="toggleRecording()">
        <span class="btn-label" id="play-label">CHIEDI</span>
        <span class="btn-sub" id="play-sub">Parla</span>
        <div class="wave-bar" id="wave-bar">
          <span></span><span></span><span></span><span></span><span></span><span></span><span></span>
        </div>
      </button>
    </div>

    <!-- RIGA 2: GALLERIA + DESCRIVI -->
    <div class="row-2">
      <button class="btn" id="btn-gallery" onclick="openGallery()">
        <span class="btn-label">GALLERIA</span>
        <span class="btn-sub">Scegli foto</span>
      </button>
      <button class="btn" id="btn-describe" onclick="describeScene()">
        <span class="btn-label">DESCRIVI</span>
        <span class="btn-sub">AI analizza</span>
      </button>
    </div>

    <!-- RIGA 3: BUS + ESCI -->
    <div class="row-2">
      <button class="btn" id="btn-bus" onclick="toggleGTT()">
        <span class="btn-label">BUS</span>
        <span class="btn-sub">GTT Torino</span>
      </button>
      <button class="btn" id="btn-exit" onclick="exitApp()">
        <span class="btn-label">ESCI</span>
        <span class="btn-sub">Chiudi</span>
      </button>
    </div>

    <div id="voice-transcript">Premi CHIEDI e parla. Premi di nuovo per fermare.</div>

    <!-- GTT PANEL -->
    <div id="gtt-panel">
      <div class="gtt-title">GTT TORINO</div>
      <div id="gtt-coords">Rileva la posizione, poi chiedi dove vuoi andare.</div>
      <button id="btn-gtt-location" onclick="getUserLocation()">RILEVA POSIZIONE</button>
      <button id="btn-gtt-mic" onclick="toggleGTTVoice()">
        <span id="gtt-mic-label">CHIEDI</span>
        <span id="gtt-mic-sub">Parla dopo il clic</span>
        <div id="gtt-wave-bar"><span></span><span></span><span></span><span></span><span></span></div>
      </button>
      <div id="gtt-answer" style="font-size:0.9rem;font-weight:700;color:#aaa;text-align:center;line-height:1.5;padding:0 4px;"></div>
    </div>

    <div class="bottom-spacer"></div>
  </div>
</div>

<!-- Pulsante impostazioni -->
<button id="settings-fab" onclick="openSettings()">&#9881;</button>

<!-- SETTINGS OVERLAY -->
<div id="settings-overlay" onclick="closeSettingsIfBg(event)">
  <div class="settings-sheet">
    <div class="s-handle"></div>
    <div class="s-title">IMPOSTAZIONI</div>
    <div class="s-row">
      <input class="s-input" id="settings-key" type="password" placeholder="gsk_..." autocomplete="off">
      <button class="s-save" onclick="saveKeyFromSettings()">SALVA</button>
    </div>
    <p class="s-info">API Key Groq — gratuita su <a href="https://console.groq.com/keys" target="_blank">console.groq.com/keys</a></p>
    <button class="s-close" onclick="closeSettings()">CHIUDI</button>
  </div>
</div>

<!-- FILE INPUTS -->
<input type="file" id="file-camera" accept="image/*" capture="environment" style="display:none" onchange="handleFileInput(event)">
<input type="file" id="file-gallery" accept="image/*" style="display:none" onchange="handleFileInput(event)">

<script>
// ── STATE ──
let apiKey = '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';
let currentImageBase64 = null;
let recognition = null;
let isRecording = false;
let accumulatedTranscript = '';
let gttOpen = false;
let userLat = null, userLon = null;

// ── INIT ──
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('app').style.display = 'flex';
  setStatus('Pronto.', 'idle');
  setTimeout(() => speak('MyEyes pronto. Scatta una foto o fai una domanda.'), 500);

  ['btn-camera','btn-gallery','btn-describe','btn-bus','btn-play','btn-exit'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('touchstart', () => navigator.vibrate && navigator.vibrate(20), { passive: true });
  });
});

// ── STATUS ──
function setStatus(msg, state = 'idle') {
  document.getElementById('status-text').textContent = msg;
  const dot = document.getElementById('status-dot');
  dot.className = state === 'active' ? 'active' : state === 'listening' ? 'listening' : state === 'error' ? 'error' : '';
}

// ── TTS ──
function speak(text, onEnd) {
  if (!text) { if (onEnd) onEnd(); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'it-IT'; u.rate = 0.93; u.pitch = 1; u.volume = 1;
  u.onend = () => { if (onEnd) onEnd(); };
  u.onerror = () => { if (onEnd) onEnd(); };
  setTimeout(() => window.speechSynthesis.speak(u), 80);
}

// ── CAMERA / GALLERY ──
function openCamera() {
  speak('Apro la fotocamera.');
  document.getElementById('file-camera').click();
}
function openGallery() {
  speak('Scegli una immagine dalla galleria.');
  document.getElementById('file-gallery').click();
}
function handleFileInput(event) {
  const file = event.target.files[0];
  event.target.value = '';
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    currentImageBase64 = e.target.result.split(',')[1];
    document.getElementById('preview-img').src = e.target.result;
    document.getElementById('preview-wrap').style.display = 'block';
    setStatus('Immagine caricata. Tocca DESCRIVI.', 'active');
    speak('Immagine caricata. Tocca Descrivi per sentire la descrizione.');
  };
  reader.readAsDataURL(file);
}
function clearImage() {
  currentImageBase64 = null;
  document.getElementById('preview-wrap').style.display = 'none';
  document.getElementById('preview-img').src = '';
  setStatus('Immagine rimossa.', 'idle');
}

// ── DESCRIVI SCENA ──
async function describeScene() {
  if (!currentImageBase64) {
    speak('Nessuna immagine caricata. Prima scatta una foto o scegli dalla galleria.');
    return;
  }
  setStatus('Analisi AI in corso...', 'active');
  speak('Sto analizzando la scena, un momento.');
  const prompt = `Sei un assistente vocale per ipovedenti italiani. Analizza questa immagine e descrivi in italiano con frasi parlate naturali (massimo 5 frasi, nessun elenco, nessun simbolo, nessun markdown):
1. Cosa c'e' di piu' importante (persone, veicoli, oggetti, ambiente generale).
2. Pericoli o ostacoli per chi cammina (gradini, auto, lavori, oggetti a terra).
3. Semafori: specifica CHIARAMENTE il colore esatto visibile (rosso significa fermati, verde significa puoi passare).
4. Indicazioni di orientamento utili (insegne stradali, nomi di negozi, edifici).
Parla direttamente alla persona in modo rassicurante. Inizia con: "Davanti a te..."`;
  try {
    const result = await callGroqVision(prompt, currentImageBase64);
    setStatus('Descrizione completata.', 'active');
    speak(result);
  } catch (e) {
    setStatus('Errore: ' + e.message, 'error');
    speak('Errore durante la descrizione. Controlla la connessione.');
  }
}

// ── CHIEDI TOGGLE (1° clic = avvia, 2° clic = ferma) ──
function toggleRecording() {
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

function startRecording() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    speak('Il riconoscimento vocale non e\' disponibile. Usa Safari su iPhone.');
    return;
  }
  accumulatedTranscript = '';
  document.getElementById('voice-transcript').textContent = 'In ascolto...';

  recognition = new SR();
  recognition.lang = 'it-IT';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    isRecording = true;
    setStatus('In ascolto... parla ora', 'listening');
    document.getElementById('wave-bar').classList.add('show');
    document.getElementById('btn-play').classList.add('recording');
    document.getElementById('play-label').textContent = 'STOP';
    document.getElementById('play-sub').textContent = 'Tocca per fermare';
  };

  recognition.onresult = (e) => {
    let finalChunk = '', interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalChunk += e.results[i][0].transcript + ' ';
      else interim += e.results[i][0].transcript;
    }
    accumulatedTranscript += finalChunk;
    const display = (accumulatedTranscript + interim).trim();
    document.getElementById('voice-transcript').textContent = display || 'In ascolto...';
  };

  recognition.onerror = (e) => {
    if (e.error === 'no-speech') return;
    isRecording = false;
    resetVoiceUI();
    setStatus('Errore: ' + e.error, 'error');
    speak('Non ho capito. Riprova.');
  };

  recognition.onend = () => {
    if (isRecording) {
      // Safari a volte ferma da solo — riavvia se ancora in modalità ascolto
      try { recognition.start(); } catch(err) {
        isRecording = false;
        resetVoiceUI();
        processVoiceInput();
      }
    }
  };

  // Avvio diretto senza speak() — su Safari TTS e STT non possono girare insieme
  try { recognition.start(); } catch(e) { console.warn(e); }
}

function stopRecording() {
  if (!isRecording) return;
  isRecording = false;
  if (recognition) { try { recognition.stop(); } catch(e){} recognition = null; }
  resetVoiceUI();
  processVoiceInput();
}

function resetVoiceUI() {
  document.getElementById('wave-bar').classList.remove('show');
  document.getElementById('btn-play').classList.remove('recording');
  document.getElementById('play-label').textContent = 'CHIEDI';
  document.getElementById('play-sub').textContent = 'Parla';
}

async function processVoiceInput() {
  const transcript = accumulatedTranscript.trim();
  if (!transcript) {
    setStatus('Nessuna parola rilevata.', 'idle');
    document.getElementById('voice-transcript').textContent = 'Nessuna parola. Premi CHIEDI e riprova.';
    speak('Non ho sentito nulla. Premi Chiedi e riprova.');
    return;
  }
  setStatus('Hai detto: ' + transcript, 'active');
  document.getElementById('voice-transcript').textContent = transcript;

  // Comandi speciali
  const lo = transcript.toLowerCase();
  if (/\b(scatta|fotocamera|fai una foto|foto)\b/.test(lo)) { openCamera(); return; }
  if (/\b(galleria|carica|scegli foto)\b/.test(lo)) { openGallery(); return; }
  if (/\b(descrivi|analizza|cosa vedi|descrizione)\b/.test(lo)) { describeScene(); return; }
  if (/\b(bus|tram|orari|fermata)\b/.test(lo)) { if (!gttOpen) toggleGTT(); else speak('Il pannello bus e\' gia\' aperto.'); return; }
  if (/\b(esci|chiudi)\b/.test(lo)) { exitApp(); return; }

  setStatus('Elaboro...', 'active');
  try {
    let answer;
    if (currentImageBase64) {
      const prompt = `L'utente ipovedente guarda questa immagine e chiede: "${transcript}". Rispondi in italiano, in modo diretto e conciso (max 3 frasi parlate, nessun elenco, nessun simbolo).`;
      answer = await callGroqVision(prompt, currentImageBase64);
    } else {
      answer = await callGroqChat(transcript);
    }
    // Pulisce eventuale markdown residuo prima di leggere
    const clean = answer.replace(/[*_#`>]/g, '').trim();
    speak(clean);
    setStatus('Risposta completata.', 'active');
    document.getElementById('voice-transcript').textContent = clean;
  } catch (e) {
    speak('Errore di rete. Controlla la connessione e riprova.');
    setStatus('Errore: ' + e.message, 'error');
  }
}

// ── GROQ API ──
async function callGroqVision(prompt, imageBase64) {
  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
    body: JSON.stringify({
      model: 'meta-llama/llama-4-scout-17b-16e-instruct',
      messages: [{
        role: 'user',
        content: [
          { type: 'text', text: prompt },
          { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,' + imageBase64 } }
        ]
      }],
      max_tokens: 400
    })
  });
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'HTTP ' + res.status); }
  return (await res.json()).choices[0].message.content;
}

async function callGroqChat(msg) {
  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
    body: JSON.stringify({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { role: 'system', content: 'Sei un assistente vocale per ipovedenti italiani. Rispondi in italiano, in modo breve e chiaro (massimo 3 frasi parlate), senza elenchi, senza simboli, senza markdown, senza asterischi. Il testo sara\' letto ad alta voce.' },
        { role: 'user', content: msg }
      ],
      max_tokens: 250
    })
  });
  if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.error?.message || 'HTTP ' + res.status); }
  return (await res.json()).choices[0].message.content;
}

// ── GTT ──
let gttRecognition = null;
let isGttRecording = false;
let gttTranscript = '';

function toggleGTT() {
  gttOpen = !gttOpen;
  document.getElementById('gtt-panel').classList.toggle('open', gttOpen);
  if (gttOpen) speak('Pannello bus aperto. Rileva la posizione poi chiedi dove vuoi andare.');
  else { speak('Pannello bus chiuso.'); stopGTTVoice(); }
}

function getUserLocation() {
  if (!navigator.geolocation) {
    speak('Geolocalizzazione non disponibile su questo dispositivo.');
    return;
  }
  setStatus('Rilevo la posizione GPS...', 'active');
  document.getElementById('gtt-coords').textContent = 'Rilevamento in corso...';
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      userLat = pos.coords.latitude.toFixed(6);
      userLon = pos.coords.longitude.toFixed(6);
      const acc = Math.round(pos.coords.accuracy);
      document.getElementById('gtt-coords').textContent =
        'Posizione rilevata. Precisione: ' + acc + ' metri.';
      setStatus('Posizione rilevata.', 'active');
      speak('Posizione rilevata. Ora premi Chiedi e dimmi dove vuoi andare.');
    },
    () => {
      document.getElementById('gtt-coords').textContent = 'GPS non disponibile. Controlla i permessi in Impostazioni Safari.';
      setStatus('Errore GPS', 'error');
      speak('Non riesco a rilevare la posizione. Controlla i permessi di localizzazione.');
    },
    { enableHighAccuracy: true, timeout: 15000 }
  );
}

function toggleGTTVoice() {
  if (isGttRecording) {
    stopGTTVoice();
  } else {
    startGTTVoice();
  }
}

function startGTTVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { speak('Voce non disponibile. Usa Safari su iPhone.'); return; }

  gttTranscript = '';
  isGttRecording = true;

  document.getElementById('btn-gtt-mic').classList.add('recording');
  document.getElementById('gtt-mic-label').textContent = 'STOP';
  document.getElementById('gtt-mic-sub').textContent = 'Tocca per fermare';
  document.getElementById('gtt-wave-bar').classList.add('show');

  gttRecognition = new SR();
  gttRecognition.lang = 'it-IT';
  gttRecognition.continuous = true;
  gttRecognition.interimResults = true;
  gttRecognition.maxAlternatives = 1;

  gttRecognition.onresult = (e) => {
    let fin = '', int = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) fin += e.results[i][0].transcript + ' ';
      else int += e.results[i][0].transcript;
    }
    gttTranscript += fin;
    const disp = (gttTranscript + int).trim();
    document.getElementById('gtt-answer').textContent = disp || 'In ascolto...';
  };

  gttRecognition.onerror = (e) => {
    if (e.error === 'no-speech') return;
    isGttRecording = false;
    resetGTTVoiceUI();
    speak('Errore microfono. Riprova.');
  };

  gttRecognition.onend = () => {
    if (isGttRecording) {
      try { gttRecognition.start(); } catch(err) {
        isGttRecording = false;
        resetGTTVoiceUI();
        processGTTVoice();
      }
    }
  };

  try { gttRecognition.start(); } catch(e) { console.warn(e); }
}

function stopGTTVoice() {
  if (!isGttRecording) return;
  isGttRecording = false;
  if (gttRecognition) { try { gttRecognition.stop(); } catch(e){} gttRecognition = null; }
  resetGTTVoiceUI();
  processGTTVoice();
}

function resetGTTVoiceUI() {
  document.getElementById('btn-gtt-mic').classList.remove('recording');
  document.getElementById('gtt-mic-label').textContent = 'CHIEDI';
  document.getElementById('gtt-mic-sub').textContent = 'Parla dopo il clic';
  document.getElementById('gtt-wave-bar').classList.remove('show');
}

async function processGTTVoice() {
  const t = gttTranscript.trim();
  if (!t) { speak('Non ho sentito nulla. Riprova.'); return; }

  document.getElementById('gtt-answer').textContent = 'Cerco: ' + t;
  speak('Cerco come arrivare a ' + t);
  setStatus('Cerco trasporti...', 'active');

  const posInfo = (userLat && userLon)
    ? 'Sono a Torino alle coordinate lat ' + userLat + ' lon ' + userLon + '.'
    : 'Sono a Torino (posizione esatta non disponibile).';

  const prompt = posInfo + ' Voglio andare a: ' + t + '. Dimmi quale linea GTT (bus o tram) devo prendere, dove salire e quante fermate fare. Rispondi in italiano, massimo 4 frasi parlate senza elenchi senza simboli senza markdown.';

  try {
    const answer = await callGroqChat(prompt);
    const clean = answer.replace(/[*_#`>\-]/g, '').trim();
    document.getElementById('gtt-answer').textContent = clean;
    speak(clean);
    setStatus('Risposta pronta.', 'active');
  } catch(err) {
    speak('Errore di rete. Controlla la connessione.');
    setStatus('Errore', 'error');
  }
}

// ── EXIT — interrompe tutto e chiude ──
function exitApp() {
  // Ferma sintesi vocale
  window.speechSynthesis.cancel();
  // Ferma riconoscimento vocale principale
  if (recognition) { try { recognition.stop(); } catch(e){} recognition = null; }
  isRecording = false;
  resetVoiceUI();
  // Ferma riconoscimento GTT
  if (gttRecognition) { try { gttRecognition.stop(); } catch(e){} gttRecognition = null; }
  isGttRecording = false;
  // Parla e chiudi
  const u = new SpeechSynthesisUtterance('Arrivederci.');
  u.lang = 'it-IT'; u.rate = 0.93;
  u.onend = () => { try { window.close(); } catch(e){} location.href = 'about:blank'; };
  u.onerror = () => { try { window.close(); } catch(e){} location.href = 'about:blank'; };
  setTimeout(() => window.speechSynthesis.speak(u), 80);
}

// ── SETTINGS ──
function openSettings() { document.getElementById('settings-key').value = apiKey; document.getElementById('settings-overlay').classList.add('open'); }
function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); }
function closeSettingsIfBg(e) { if (e.target === document.getElementById('settings-overlay')) closeSettings(); }
function saveKeyFromSettings() {
  const val = document.getElementById('settings-key').value.trim();
  if (val.startsWith('gsk_')) { apiKey = val; closeSettings(); speak('Chiave salvata.'); }
  else speak('Chiave non valida. Deve iniziare con gsk.');
}
</script>
</body>
</html>
