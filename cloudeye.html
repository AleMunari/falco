<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="CloudEye">
<meta name="theme-color" content="#0d1117">
<title>CloudEye</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d1117;
  --surface: #161b22;
  --card: #21262d;
  --border: #30363d;
  --gold: #f0b429;
  --gold-dim: #c48a00;
  --blue: #58a6ff;
  --green: #3fb950;
  --orange: #f78166;
  --purple: #bc8cff;
  --text: #e6edf3;
  --muted: #8b949e;
  --r: 20px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  height: 100%; width: 100%;
  background: var(--bg);
  font-family: 'DM Sans', sans-serif;
  color: var(--text);
  overflow: hidden;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#setup {
  position: fixed; inset: 0; z-index: 200;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 32px 28px; gap: 22px;
}
.setup-logo {
  font-family: 'Syne', sans-serif;
  font-size: 3rem; font-weight: 800;
  color: var(--gold);
  letter-spacing: -2px;
  line-height: 1;
}
.setup-sub {
  color: var(--muted); font-size: 1rem;
  text-align: center; line-height: 1.6;
  max-width: 320px;
}
.setup-label {
  width: 100%; font-size: 0.85rem;
  color: var(--muted); text-align: left;
  margin-bottom: -14px;
}
.setup-input {
  width: 100%; padding: 18px 20px;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 1rem; outline: none;
  transition: border-color .2s;
}
.setup-input:focus { border-color: var(--gold); }
.setup-btn {
  width: 100%; padding: 22px;
  background: var(--gold); color: #0d1117;
  border: none; border-radius: 16px;
  font-family: 'Syne', sans-serif;
  font-size: 1.2rem; font-weight: 800;
  cursor: pointer; letter-spacing: -0.5px;
  transition: opacity .15s, transform .15s;
}
.setup-btn:active { opacity: .85; transform: scale(.97); }
.setup-hint {
  font-size: 0.8rem; color: var(--muted);
  text-align: center; line-height: 1.5;
}
.setup-hint a { color: var(--blue); }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#app {
  display: none;
  position: fixed; inset: 0;
  flex-direction: column;
  background: var(--bg);
  padding: 0;
  overflow: hidden;
}

/* HEADER */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px 12px;
  padding-top: max(16px, env(safe-area-inset-top));
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-size: 1.6rem; font-weight: 800;
  color: var(--gold); letter-spacing: -1px;
}
.settings-btn {
  width: 42px; height: 42px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 1.1rem;
}

/* STATUS BAR */
#status-bar {
  padding: 10px 20px;
  background: var(--surface);
  font-size: 0.85rem; color: var(--muted);
  min-height: 40px;
  display: flex; align-items: center; gap: 8px;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}
#status-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--muted); flex-shrink: 0;
  transition: background .3s;
}
#status-dot.active { background: var(--green); animation: pulse 1.5s infinite; }
#status-dot.listening { background: var(--blue); animation: pulse .8s infinite; }
#status-dot.error { background: var(--orange); }
@keyframes pulse {
  0%, 100% { opacity: 1; } 50% { opacity: .3; }
}
#status-text { flex: 1; line-height: 1.3; }

/* SCROLL AREA */
.scroll-area {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  padding: 20px 18px;
  display: flex; flex-direction: column; gap: 14px;
  -webkit-overflow-scrolling: touch;
}

/* PREVIEW */
#preview-wrap {
  display: none;
  width: 100%; border-radius: var(--r);
  overflow: hidden; position: relative;
  background: var(--card);
  border: 1px solid var(--border);
  max-height: 220px;
}
#preview-img {
  width: 100%; object-fit: cover;
  max-height: 220px; display: block;
}
.preview-close {
  position: absolute; top: 10px; right: 10px;
  width: 34px; height: 34px;
  background: rgba(0,0,0,.7); border: none;
  border-radius: 50%; color: white;
  font-size: 1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* MAIN ACTION BUTTONS */
.btn-row { display: grid; gap: 12px; }
.btn-row-2 { grid-template-columns: 1fr 1fr; }

.action-btn {
  padding: 22px 16px;
  border: none; border-radius: var(--r);
  cursor: pointer;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px; text-align: center;
  transition: transform .15s, opacity .15s, box-shadow .2s;
  position: relative; overflow: hidden;
  font-family: 'Syne', sans-serif;
}
.action-btn:active { transform: scale(.96); opacity: .85; }
.action-btn .btn-icon {
  font-size: 2.2rem; line-height: 1;
  display: block;
}
.action-btn .btn-label {
  font-size: 0.9rem; font-weight: 700;
  letter-spacing: -0.3px; line-height: 1.2;
}
.action-btn .btn-sub {
  font-size: 0.72rem; color: rgba(255,255,255,.65);
  font-family: 'DM Sans', sans-serif;
  font-weight: 400; line-height: 1.3;
}

/* LARGE CAMERA BTN */
#btn-camera {
  padding: 34px 16px;
  background: linear-gradient(135deg, #f0b429 0%, #e09000 100%);
  color: #0d1117;
  box-shadow: 0 6px 30px rgba(240,180,41,.35);
  grid-column: 1 / -1;
}
#btn-camera .btn-icon { font-size: 3rem; }
#btn-camera .btn-label { font-size: 1.2rem; }
#btn-camera .btn-sub { color: rgba(0,0,0,.6); }

#btn-gallery {
  background: var(--card);
  border: 1.5px solid var(--border);
  color: var(--text);
}
#btn-voice-q {
  background: linear-gradient(135deg, #58a6ff 0%, #1a73e8 100%);
  color: white;
  box-shadow: 0 4px 20px rgba(88,166,255,.3);
}
#btn-describe {
  background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%);
  color: white;
  box-shadow: 0 4px 20px rgba(63,185,80,.25);
  grid-column: 1 / -1;
}
#btn-bus {
  background: linear-gradient(135deg, #bc8cff 0%, #8957e5 100%);
  color: white;
  box-shadow: 0 4px 20px rgba(188,140,255,.3);
  grid-column: 1 / -1;
}

/* RECORDING ANIMATION */
.recording-ring {
  position: absolute; inset: 0;
  border-radius: var(--r);
  border: 3px solid rgba(255,255,255,.8);
  animation: ring-pulse 1s ease-in-out infinite;
  pointer-events: none;
  opacity: 0;
}
.recording .recording-ring { opacity: 1; }
@keyframes ring-pulse {
  0%, 100% { transform: scale(1); opacity: .8; }
  50% { transform: scale(1.03); opacity: .2; }
}

/* GTT PANEL */
#gtt-panel {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px;
  gap: 14px;
  flex-direction: column;
}
#gtt-panel.open { display: flex; }
.gtt-title {
  font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 1rem;
  color: var(--purple);
}
.gtt-input {
  width: 100%; padding: 14px 16px;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem; outline: none;
  transition: border-color .2s;
}
.gtt-input:focus { border-color: var(--purple); }
.gtt-row { display: flex; gap: 10px; }
.gtt-btn {
  flex: 1; padding: 14px 10px;
  border: none; border-radius: 12px;
  font-family: 'Syne', sans-serif;
  font-size: 0.85rem; font-weight: 700;
  cursor: pointer;
  transition: opacity .15s, transform .15s;
}
.gtt-btn:active { opacity: .8; transform: scale(.97); }
.gtt-btn-voice {
  background: var(--purple); color: white;
  flex: 0 0 52px; font-size: 1.2rem;
}
.gtt-btn-search {
  background: var(--gold); color: #0d1117;
}
.gtt-btn-open {
  background: var(--card);
  border: 1.5px solid var(--border);
  color: var(--text); font-size: 0.8rem;
}
#gtt-coords {
  font-size: 0.78rem; color: var(--muted);
  line-height: 1.4;
}

/* BOTTOM SAFE AREA */
.bottom-spacer {
  height: env(safe-area-inset-bottom, 20px);
  flex-shrink: 0;
}

/* SETTINGS OVERLAY */
#settings-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.7);
  align-items: flex-end;
}
#settings-overlay.open { display: flex; }
.settings-sheet {
  width: 100%;
  background: var(--surface);
  border-radius: 24px 24px 0 0;
  padding: 24px 24px max(24px, env(safe-area-inset-bottom));
  display: flex; flex-direction: column; gap: 16px;
}
.settings-handle {
  width: 40px; height: 4px;
  background: var(--border); border-radius: 2px;
  margin: 0 auto 8px;
}
.settings-title {
  font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 1.1rem;
}
.settings-key-row {
  display: flex; gap: 10px;
}
.settings-key-row .setup-input { flex: 1; }
.settings-save {
  padding: 14px 20px;
  background: var(--gold); color: #0d1117;
  border: none; border-radius: 12px;
  font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 0.9rem;
  cursor: pointer;
}
.settings-close-btn {
  padding: 16px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--muted);
  font-family: 'DM Sans', sans-serif;
  cursor: pointer; text-align: center;
}
.settings-info {
  font-size: 0.78rem; color: var(--muted); line-height: 1.5;
}
.settings-info a { color: var(--blue); }
</style>
</head>
<body>

<!-- ‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê -->
<div id="setup">
  <div class="setup-logo">üëÅ CloudEye</div>
  <p class="setup-sub">App accessibile per ipovedenti.<br>Analisi AI gratuita con OpenAI.</p>
  <p class="setup-label">La tua API Key OpenAI (gratuita con crediti iniziali)</p>
  <input class="setup-input" id="setup-key" type="password"
         placeholder="sk-..." autocomplete="off" autocorrect="off">
  <button class="setup-btn" onclick="saveAndStart()">‚ñ∂ INIZIA</button>
  <p class="setup-hint">
    Ottieni la key gratis su <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>.<br>
    La key √® salvata solo sul tuo iPhone, non viene trasmessa.
  </p>
</div>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê -->
<div id="app">
  <div class="header">
    <div class="logo">üëÅ CloudEye</div>
    <button class="settings-btn" onclick="openSettings()" aria-label="Impostazioni">‚öôÔ∏è</button>
  </div>

  <div id="status-bar">
    <div id="status-dot"></div>
    <div id="status-text">Pronto. Tocca un bottone o parla.</div>
  </div>

  <div class="scroll-area">

    <!-- PREVIEW IMMAGINE -->
    <div id="preview-wrap">
      <img id="preview-img" src="" alt="Immagine caricata">
      <button class="preview-close" onclick="clearImage()">‚úï</button>
    </div>

    <!-- BOTTONI PRINCIPALI -->
    <div class="btn-row btn-row-2" style="grid-template-columns:1fr">
      <button class="action-btn" id="btn-camera" onclick="openCamera()">
        <div class="recording-ring"></div>
        <span class="btn-icon">üì∑</span>
        <span class="btn-label">SCATTA FOTO</span>
        <span class="btn-sub">Apre la fotocamera</span>
      </button>
    </div>

    <div class="btn-row btn-row-2">
      <button class="action-btn" id="btn-gallery" onclick="openGallery()">
        <span class="btn-icon">üñºÔ∏è</span>
        <span class="btn-label">GALLERIA</span>
        <span class="btn-sub">Scegli immagine</span>
      </button>
      <button class="action-btn" id="btn-voice-q" onclick="startVoiceQuestion()">
        <div class="recording-ring"></div>
        <span class="btn-icon">üéôÔ∏è</span>
        <span class="btn-label">DOMANDA VOCE</span>
        <span class="btn-sub">Parla tu</span>
      </button>
    </div>

    <div class="btn-row">
      <button class="action-btn" id="btn-describe" onclick="describeScene()">
        <span class="btn-icon">üîç</span>
        <span class="btn-label">DESCRIVI SCENA</span>
        <span class="btn-sub">AI descrive ostacoli, colori, oggetti</span>
      </button>
    </div>

    <div class="btn-row">
      <button class="action-btn" id="btn-bus" onclick="toggleGTT()">
        <span class="btn-icon">üöå</span>
        <span class="btn-label">BUS / TRAM GTT</span>
        <span class="btn-sub">Orari e fermate vicine a te</span>
      </button>
    </div>

    <!-- GTT PANEL -->
    <div id="gtt-panel">
      <div class="gtt-title">üìç Fermate GTT vicino a te</div>
      <div id="gtt-coords">Posizione non rilevata.</div>
      <div class="gtt-row">
        <input class="gtt-input" id="gtt-dest" placeholder="Destinazione o numero linea..." type="text">
        <button class="gtt-btn gtt-btn-voice" onclick="voiceGTT()" title="D√¨ la destinazione">üéôÔ∏è</button>
      </div>
      <div class="gtt-row">
        <button class="gtt-btn gtt-btn-search" onclick="searchGTT()">üîç Cerca Fermate</button>
        <button class="gtt-btn gtt-btn-open" onclick="openGTTSite()">üåê Apri GTT</button>
      </div>
    </div>

    <div class="bottom-spacer"></div>
  </div>
</div>

<!-- ‚ïê‚ïê SETTINGS OVERLAY ‚ïê‚ïê -->
<div id="settings-overlay" onclick="closeSettingsIfBg(event)">
  <div class="settings-sheet">
    <div class="settings-handle"></div>
    <div class="settings-title">‚öôÔ∏è Impostazioni</div>
    <div class="settings-key-row">
      <input class="setup-input" id="settings-key" type="password"
             placeholder="sk-..." autocomplete="off">
      <button class="settings-save" onclick="saveKeyFromSettings()">Salva</button>
    </div>
    <p class="settings-info">
      API Key OpenAI. Gratis con crediti iniziali (~$5).<br>
      <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a>
    </p>
    <button class="settings-close-btn" onclick="closeSettings()">Chiudi</button>
  </div>
</div>

<!-- INPUT FILE NASCOSTI -->
<input type="file" id="file-camera" accept="image/*" capture="environment" style="display:none" onchange="handleFileInput(event)">
<input type="file" id="file-gallery" accept="image/*" style="display:none" onchange="handleFileInput(event)">

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let apiKey = '';
let currentImageBase64 = null;
let isListening = false;
let isSpeaking = false;
let currentQuestion = null;
let userLat = null;
let userLon = null;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('oai_key');
  if (saved && saved.startsWith('sk-')) {
    apiKey = saved;
    showApp();
  }
  // Avvia comandi vocali globali
  initGlobalVoiceCommands();
});

function saveAndStart() {
  const val = document.getElementById('setup-key').value.trim();
  if (!val.startsWith('sk-')) {
    speak('Inserisci una API key OpenAI valida che inizia con sk-');
    return;
  }
  apiKey = val;
  localStorage.setItem('oai_key', apiKey);
  showApp();
}

function showApp() {
  document.getElementById('setup').style.display = 'none';
  const app = document.getElementById('app');
  app.style.display = 'flex';
  setStatus('Pronto. Tocca un bottone o d√¨ un comando.', 'idle');
  speak('CloudEye pronto. Puoi scattare una foto, descrivere la scena, o chiedere gli orari del bus.');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATUS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(msg, state = 'idle') {
  document.getElementById('status-text').textContent = msg;
  const dot = document.getElementById('status-dot');
  dot.className = '';
  if (state === 'active') dot.classList.add('active');
  else if (state === 'listening') dot.classList.add('listening');
  else if (state === 'error') dot.classList.add('error');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SPEECH SYNTHESIS (TEXT TO SPEECH)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function speak(text, onEnd) {
  if (!text) { if (onEnd) onEnd(); return; }
  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'it-IT';
  utter.rate = 0.95;
  utter.pitch = 1;
  utter.volume = 1;
  isSpeaking = true;
  utter.onend = () => { isSpeaking = false; if (onEnd) onEnd(); };
  utter.onerror = () => { isSpeaking = false; if (onEnd) onEnd(); };
  // Fix iOS: aggiunge piccola pausa
  setTimeout(() => window.speechSynthesis.speak(utter), 100);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SPEECH RECOGNITION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startListening(onResult, onError) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    speak('Il riconoscimento vocale non √® supportato su questo browser. Usa Safari.');
    if (onError) onError();
    return;
  }
  const rec = new SR();
  rec.lang = 'it-IT';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.onstart = () => {
    isListening = true;
    setStatus('In ascolto‚Ä¶ parla ora', 'listening');
  };
  rec.onresult = (e) => {
    isListening = false;
    const transcript = e.results[0][0].transcript;
    setStatus('Hai detto: ' + transcript, 'active');
    if (onResult) onResult(transcript);
  };
  rec.onerror = (e) => {
    isListening = false;
    setStatus('Errore riconoscimento: ' + e.error, 'error');
    speak('Non ho capito. Riprova.');
    if (onError) onError();
  };
  rec.onend = () => { isListening = false; };
  rec.start();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GLOBAL VOICE COMMANDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initGlobalVoiceCommands() {
  // Scuoti per attivare ‚Äì non possibile senza permessi extra, usiamo double-tap sul logo
  // I comandi vocali sono attivati dal bottone "domanda voce"
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CAMERA / GALLERY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCamera() {
  speak('Apro la fotocamera.');
  document.getElementById('file-camera').click();
}

function openGallery() {
  speak('Apri la galleria e scegli una immagine.');
  document.getElementById('file-gallery').click();
}

function handleFileInput(event) {
  const file = event.target.files[0];
  event.target.value = '';
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    // Salva base64 puro (senza prefisso)
    currentImageBase64 = dataUrl.split(',')[1];
    // Mostra anteprima
    const wrap = document.getElementById('preview-wrap');
    const img = document.getElementById('preview-img');
    img.src = dataUrl;
    wrap.style.display = 'block';
    setStatus('Immagine caricata. Tocca "Descrivi Scena" o fai una domanda.', 'active');
    speak('Immagine caricata. Tocca Descrivi Scena per sentire la descrizione.');
  };
  reader.readAsDataURL(file);
}

function clearImage() {
  currentImageBase64 = null;
  document.getElementById('preview-wrap').style.display = 'none';
  document.getElementById('preview-img').src = '';
  setStatus('Immagine rimossa.', 'idle');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DESCRIBE SCENE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function describeScene() {
  if (!currentImageBase64) {
    speak('Nessuna immagine caricata. Prima scatta una foto o scegli dalla galleria.');
    return;
  }
  setStatus('Analisi AI in corso‚Ä¶', 'active');
  speak('Sto analizzando la scena, un momento.');
  const prompt = `Sei un assistente vocale per ipovedenti. Analizza questa immagine e descrivi ad alta voce, in italiano, in modo chiaro e conciso (max 4 frasi):
1. Cosa vedi di pi√π importante (persone, veicoli, oggetti).
2. Eventuali pericoli o ostacoli (gradini, auto, buche, lavori).
3. Semafori: specifica il colore (rosso, verde, giallo) se visibile.
4. Indicazioni utili all'orientamento (insegne, strade, edifici).
Parla direttamente alla persona, come se stessi descrivendo ad alta voce.`;

  try {
    const result = await callOpenAIVision(prompt, currentImageBase64);
    setStatus('Descrizione completata.', 'active');
    speak(result);
  } catch (e) {
    setStatus('Errore AI: ' + e.message, 'error');
    speak('Errore durante l\'analisi. Verifica la connessione e la API key.');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  VOICE QUESTION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startVoiceQuestion() {
  const btn = document.getElementById('btn-voice-q');
  btn.classList.add('recording');
  setStatus('In ascolto‚Ä¶ fai la tua domanda', 'listening');
  speak('Parla. Cosa vuoi sapere?', () => {
    startListening((transcript) => {
      btn.classList.remove('recording');
      currentQuestion = transcript;
      if (!currentImageBase64) {
        // Risposta generica senza immagine
        answerGeneralQuestion(transcript);
      } else {
        answerVisionQuestion(transcript);
      }
    }, () => {
      btn.classList.remove('recording');
    });
  });
}

async function answerGeneralQuestion(question) {
  setStatus('Rispondo a: ' + question, 'active');
  try {
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: 'Sei un assistente vocale per ipovedenti. Rispondi in italiano, in modo breve e chiaro (max 3 frasi), adatto ad essere letto ad alta voce.' },
          { role: 'user', content: question }
        ],
        max_tokens: 200
      })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    const answer = data.choices[0].message.content;
    speak(answer);
  } catch (e) {
    speak('Errore nella risposta. Riprova.');
    setStatus('Errore: ' + e.message, 'error');
  }
}

async function answerVisionQuestion(question) {
  setStatus('Rispondo: ' + question, 'active');
  const prompt = `L'utente (ipovedente) guarda questa immagine e chiede: "${question}". Rispondi in italiano, in modo diretto e conciso (max 3 frasi), adatto ad essere letto ad alta voce.`;
  try {
    const result = await callOpenAIVision(prompt, currentImageBase64);
    speak(result);
  } catch (e) {
    speak('Errore nell\'analisi. Riprova.');
    setStatus('Errore: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  OPENAI VISION API
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function callOpenAIVision(prompt, imageBase64) {
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + apiKey
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [{
        role: 'user',
        content: [
          { type: 'text', text: prompt },
          { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,' + imageBase64, detail: 'low' } }
        ]
      }],
      max_tokens: 350
    })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || 'HTTP ' + res.status);
  }
  const data = await res.json();
  return data.choices[0].message.content;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GTT BUS / TRAM
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let gttOpen = false;

function toggleGTT() {
  gttOpen = !gttOpen;
  const panel = document.getElementById('gtt-panel');
  if (gttOpen) {
    panel.classList.add('open');
    speak('Pannello bus e tram aperto. Rilevo la tua posizione.');
    getUserLocation();
  } else {
    panel.classList.remove('open');
    speak('Pannello chiuso.');
  }
}

function getUserLocation() {
  if (!navigator.geolocation) {
    document.getElementById('gtt-coords').textContent = 'Geolocalizzazione non disponibile.';
    speak('La geolocalizzazione non √® disponibile su questo dispositivo.');
    return;
  }
  setStatus('Rilevo la posizione GPS‚Ä¶', 'active');
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      userLat = pos.coords.latitude.toFixed(5);
      userLon = pos.coords.longitude.toFixed(5);
      document.getElementById('gtt-coords').textContent =
        `üìç Posizione: ${userLat}, ${userLon} (precisione ¬±${Math.round(pos.coords.accuracy)}m)`;
      setStatus('Posizione rilevata.', 'active');
      speak(`Posizione rilevata. Inserisci la destinazione o il numero della linea, oppure premi il bottone voce.`);
    },
    (err) => {
      document.getElementById('gtt-coords').textContent = 'Posizione non disponibile: ' + err.message;
      setStatus('Errore GPS', 'error');
      speak('Non riesco a rilevare la posizione. Verifica i permessi di localizzazione.');
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

function voiceGTT() {
  speak('D√¨ il numero della linea o la destinazione.', () => {
    startListening((t) => {
      document.getElementById('gtt-dest').value = t;
      searchGTT();
    });
  });
}

function searchGTT() {
  const dest = document.getElementById('gtt-dest').value.trim();
  if (!dest && !userLat) {
    speak('Inserisci una destinazione o permetti la geolocalizzazione.');
    return;
  }
  // Costruisce URL GTT con coordinate o testo
  let url = '';
  if (userLat && userLon && !dest) {
    // Apri mappa vicino a posizione
    url = `https://www.gtt.to.it/cms/percorri/orari-e-percorsi?lat=${userLat}&lon=${userLon}`;
  } else if (dest) {
    url = `https://www.gtt.to.it/cms/percorri/orari-e-percorsi?cerca=${encodeURIComponent(dest)}`;
  } else {
    url = 'https://www.gtt.to.it/cms/percorri/orari-e-percorsi';
  }
  speak(`Apro GTT per ${dest || 'la tua posizione'}.`);
  window.open(url, '_blank');
}

function openGTTSite() {
  speak('Apro il sito GTT.');
  window.open('https://www.gtt.to.it/cms/percorri/orari-e-percorsi', '_blank');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSettings() {
  document.getElementById('settings-key').value = apiKey;
  document.getElementById('settings-overlay').classList.add('open');
}
function closeSettings() {
  document.getElementById('settings-overlay').classList.remove('open');
}
function closeSettingsIfBg(e) {
  if (e.target === document.getElementById('settings-overlay')) closeSettings();
}
function saveKeyFromSettings() {
  const val = document.getElementById('settings-key').value.trim();
  if (val.startsWith('sk-')) {
    apiKey = val;
    localStorage.setItem('oai_key', apiKey);
    closeSettings();
    speak('API key salvata.');
  } else {
    speak('Key non valida.');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GLOBAL VOICE COMMAND (hold logo)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Double tap su logo attiva riconoscimento
let logoTapCount = 0;
document.querySelector && window.addEventListener('DOMContentLoaded', () => {
  const logo = document.querySelector('.logo');
  if (logo) {
    logo.addEventListener('click', () => {
      logoTapCount++;
      if (logoTapCount >= 2) {
        logoTapCount = 0;
        activateGlobalCommand();
      }
      setTimeout(() => { logoTapCount = 0; }, 600);
    });
  }
});

function activateGlobalCommand() {
  speak('Dimmi cosa fare.', () => {
    startListening((t) => {
      const lower = t.toLowerCase();
      if (lower.includes('foto') || lower.includes('fotocamera') || lower.includes('scatta')) {
        openCamera();
      } else if (lower.includes('galleria') || lower.includes('immagine')) {
        openGallery();
      } else if (lower.includes('descrivi') || lower.includes('descrizione') || lower.includes('vedi')) {
        describeScene();
      } else if (lower.includes('bus') || lower.includes('tram') || lower.includes('orari')) {
        if (!gttOpen) toggleGTT();
        else speak('Il pannello bus √® gi√† aperto.');
      } else if (lower.includes('chiudi') || lower.includes('stop')) {
        speak('Ok, fermo.');
      } else {
        answerGeneralQuestion(t);
      }
    });
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FEEDBACK TATTILE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vibrate(pattern) {
  if ('vibrate' in navigator) navigator.vibrate(pattern);
}

// Aggiunge vibrazione ai bottoni principali
document.addEventListener('DOMContentLoaded', () => {
  ['btn-camera', 'btn-gallery', 'btn-voice-q', 'btn-describe', 'btn-bus'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('touchstart', () => vibrate(30), { passive: true });
  });
});
</script>
</body>
</html>
